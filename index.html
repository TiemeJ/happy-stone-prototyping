<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Stones Dashboard</title>
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            min-height: 100vh;
        }
        
        .arrow-icon {
            background: none;
            border: none;
        }
        
        .journey-marker-container {
            background: none;
            border: none;
        }
        
        .journey-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background-color: #0ead69;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .journey-marker-final {
            background-color: #e74c3c;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        /* Folders section with best stone */
        .folders-section {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Folders grid */
        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .folder-card {
            background: #f1f9fe;
            padding: 15px 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #d1e3fa;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .folder-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #e4f3ff;
        }

        .folder-card.active {
            border: 2px solid #84fab0;
            background: #e4ffef;
        }

        .folder-icon {
            font-size: 2.2em;
            color: #4a90e2;
            margin-bottom: 8px;
        }

        .folder-card.active .folder-icon {
            color: #0ead69;
        }

        .folder-card h3 {
            margin: 0;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .folder-card p {
            margin: 5px 0 0;
            font-size: 0.8em;
            color: #666;
        }

        /* Best stone card */
        .best-stone-card {
            background: #f0fff4;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 3px solid #84fab0;
            height: fit-content;
            width: 200px;
            display: grid;
            grid-template-columns: auto auto;
            align-items: center;
            gap: 10px;
        }
        
        .best-stone-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .best-stone-right {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Updated for transparency */
        .best-stone-photo {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border-radius: 8px;
            margin: 0;
            background: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
            cursor: pointer;
            transition: transform 0.2s;
        }

        .best-stone-photo:hover {
            transform: scale(1.05);
        }

        .best-stone-trophy {
            font-size: 1.4em;
            color: #f1c40f;
            margin-bottom: 2px;
        }

        .view-stone-btn {
            background: #84fab0;
            color: #2c3e50;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 3px;
        }

        .view-stone-btn:hover {
            background: #5ae296;
            transform: translateY(-2px);
        }

        /* Back button */
        .back-button {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .back-button:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        /* Stones grid */
        .stones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stone-card {
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }

        .stone-card:hover {
            transform: translateY(-2px);
            background: #f8f9fa;
        }

        .stone-card.active {
            border: 2px solid #84fab0;
            background: #f0fff4;
        }

        .stone-card h3 {
            margin: 0;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .stone-card p {
            margin: 5px 0 0;
            font-size: 0.8em;
            color: #666;
        }

        #journeyMap {
            height: 400px;
            width: 100%;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .journey-details {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .journey-entry {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #84fab0;
        }

        .recent-updates {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            max-height: 800px;
            overflow-y: auto;
        }

        .update-entry {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #8fd3f4;
        }

        .update-content {
            width: 100%;
        }

        .update-entry h3 {
            margin: 0 0 5px 0;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .update-entry p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .update-entry .timestamp {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            margin: 0;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            font-size: 1.2em;
            color: #84fab0;
            font-weight: bold;
        }

        /* Updated journey photo for transparency */
        .journey-photo {
            max-width: 200px;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.2s;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            background: transparent;
        }

        .journey-photo:hover {
            transform: scale(1.05);
        }

        /* Updated update photo for transparency */
        .update-photo {
            width: 100%;
            max-width: 250px;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            background: transparent;
            display: block;
        }

        .update-photo:hover {
            transform: scale(1.02);
        }

        /* Updated photo modal for transparency and increased z-index */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000; /* Increased from 1000 to 10000 to go above Leaflet controls */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            background: transparent;
            z-index: 10001; /* Ensure content stays above overlay */
        }

        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25));
            background: transparent;
        }

        .close-modal {
            position: absolute;
            top: -40px;
            right: -40px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 10px;
            transition: transform 0.2s;
            z-index: 10002; /* Ensure close button stays above everything */
        }

        .close-modal:hover {
            transform: scale(1.1);
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* Admin upload section */
        .admin-upload-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .admin-upload-section h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-input-container input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            display: block;
            padding: 8px 16px;
            cursor: pointer;
            background: #f1f3f5;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.9em;
            transition: all 0.2s;
            text-align: center;
            margin-bottom: 10px;
        }

        .custom-file-upload:hover {
            background: #e9ecef;
        }

        .upload-btn {
            background: #84fab0;
            color: #2c3e50;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .upload-btn:hover {
            background: #5ae296;
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .file-name {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* Updated stone feature image for transparency */
        .stone-feature-image {
            max-width: 150px;
            max-height: 150px;
            object-fit: contain;
            border-radius: 8px;
            margin: 10px auto;
            cursor: pointer;
            transition: transform 0.2s;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            background: transparent;
            display: block;
            border: none;
        }

        .stone-feature-image:hover {
            transform: scale(1.05);
        }

        .feature-photo-container {
            background: #f0fff4 !important;
            border-left: 4px solid #84fab0 !important;
            text-align: center;
        }

        /* Stone placeholder style */
        .stone-placeholder {
            width: 150px;
            height: 150px;
            margin: 5px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(245, 245, 245, 0.5);
            border: 2px dashed rgba(132, 250, 176, 0.5);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            .journey-photo, .stone-feature-image {
                max-width: 100%;
            }
            
            .folders-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            .folders-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🪨 Happy Stones Dashboard</h1>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator">
            Loading...
        </div>

        <!-- Photo Modal -->
        <div id="photoModal" class="photo-modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closePhotoModal()">×</button>
                <img id="modalImage" src="" alt="Stone location">
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Stones</h3>
                <p id="totalStones">0</p>
            </div>
            <div class="stat-card">
                <h3>Total Journeys</h3>
                <p id="totalJourneys">0</p>
            </div>
            <div class="stat-card">
                <h3>Active This Month</h3>
                <p id="activeStones">0</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="recent-updates">
                <h2>Recent Updates</h2>
                <div id="recentUpdates"></div>
            </div>

            <div class="main-content">
                <!-- Folders view -->
                <div id="foldersView">
                    <h2>Stone Collections</h2>
                    <div class="folders-section">
                        <div class="folders-grid" id="foldersGrid"></div>
                        <div class="best-stone-card" id="bestStoneCard">
                            <div class="best-stone-left">
                                <div class="best-stone-trophy">🏆</div>
                                <h3 style="margin: 0 0 2px 0; font-size: 0.85em;">Top Stone</h3>
                                <div id="bestStoneInfo">...</div>
                            </div>
                            <div id="bestStonePhoto" class="best-stone-right">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Stones view (initially hidden) -->
                <div id="stonesView" style="display: none;">
                    <div class="back-button" onclick="showFolders()">
                        <span>←</span> Back to Collections
                    </div>
                    <h2 id="currentFolderTitle">Stones</h2>
                    <div class="stones-grid" id="stonesGrid"></div>
                </div>
                
                <div class="map-container" style="display: flex; gap: 20px; margin: 20px 0;">
                    <div style="flex: 1;">
                        <h3 style="margin-top: 0; text-align: center; color: #2c3e50;">Stone Journey</h3>
                        <div id="journeyMap" style="height: 400px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"></div>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin-top: 0; text-align: center; color: #2c3e50;">All Stones Map</h3>
                        <div id="allStonesMap" style="height: 400px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"></div>
                    </div>
                </div>
                <div class="journey-details" id="journeyDetails"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase first
        const firebaseConfig = {
            apiKey: "AIzaSyBVMOTMubOV8Y1iEpK-E0TqZC5MptS6jpk",
            authDomain: "happy-stone-tracker.firebaseapp.com",
            projectId: "happy-stone-tracker",
            storageBucket: "happy-stone-tracker.firebasestorage.app",
            messagingSenderId: "454968587977",
            appId: "1:454968587977:web:cce4e67177cdf8029ebf18",
            measurementId: "G-CV38E0V9E4"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        
        // Initialize Firestore and Storage after app initialization
        const db = firebase.firestore();
        const storage = firebase.storage();
        let currentMap = null;
        let allStonesMap = null;
        let activeStoneId = null;
        let selectedFile = null;
        let currentFolderId = null;
        let allStones = []; // Store all stones data
        let allStonesMarkers = []; // Store markers for all stones

        // Loading indicator functions
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Function to show folders view and hide stones view
        function showFolders() {
            document.getElementById('foldersView').style.display = 'block';
            document.getElementById('stonesView').style.display = 'none';
            currentFolderId = null;
            
            // Remove active class from all folder cards
            document.querySelectorAll('.folder-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        // Function to show stones in a specific folder
        function showStonesInFolder(folderId, folderName) {
            currentFolderId = folderId;
            
            console.log(`Opening folder ${folderId}: ${folderName}`);
            
            // Update active folder
            document.querySelectorAll('.folder-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.folderId === folderId) {
                    card.classList.add('active');
                }
            });
            
            // Update folder title
            document.getElementById('currentFolderTitle').textContent = folderName;
            
            // Show stones view, hide folders view
            document.getElementById('foldersView').style.display = 'none';
            document.getElementById('stonesView').style.display = 'block';
            
            // Clear stones grid
            const stonesGrid = document.getElementById('stonesGrid');
            stonesGrid.innerHTML = '';
            
            // Filter stones for this folder and display them
            const [minStone, maxStone] = folderId.split('-').map(Number);
            
            console.log(`Filtering stones for range ${minStone}-${maxStone}`);
            
            const folderStones = allStones.filter(stone => {
                // Extract numeric part from stone ID (handles both numeric IDs and IDs with prefixes)
                const stoneIdStr = stone.id.toString();
                const numericPart = stoneIdStr.replace(/\D/g, '');
                const stoneNum = parseInt(numericPart);
                
                // Debug log
                console.log(`Stone ${stoneIdStr}, numeric value: ${stoneNum}, in range ${minStone}-${maxStone}? ${stoneNum >= minStone && stoneNum <= maxStone}`);
                
                if (isNaN(stoneNum)) return false;
                return stoneNum >= minStone && stoneNum <= maxStone;
            });
            
            console.log(`Found ${folderStones.length} stones for folder ${folderId}`);
            
            // Sort stones by ID
            folderStones.sort((a, b) => {
                const numA = parseInt(a.id.toString().replace(/\D/g, ''));
                const numB = parseInt(b.id.toString().replace(/\D/g, ''));
                return numA - numB;
            });
            
            // Create and append stone cards
            folderStones.forEach(stone => {
                stonesGrid.appendChild(stone.card);
            });
        }

        async function getCoordinates(locationString) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationString)}`);
                const data = await response.json();
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error("Error geocoding location:", error);
                return null;
            }
        }

        // Updated function to hide map controls when showing modal
        function openPhotoModal(url) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            
            // Hide map controls when opening modal
            document.querySelectorAll('.leaflet-control-container').forEach(control => {
                control.style.visibility = 'hidden';
            });
            
            modal.style.display = 'flex';
            modalImg.src = url;
        }

        // Updated function to restore map controls when closing modal
        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            
            // Restore map controls when closing modal
            document.querySelectorAll('.leaflet-control-container').forEach(control => {
                control.style.visibility = 'visible';
            });
            
            modal.style.display = 'none';
        }

        // Function to find the best performing stone
        async function findBestPerformingStone() {
            try {
                let bestStone = null;
                let maxJourneyCount = 0;
                let tiedStones = [];

                // First, find the maximum journey count and all stones with that count
                for (const stone of allStones) {
                    if (stone.journeyCount > maxJourneyCount) {
                        maxJourneyCount = stone.journeyCount;
                        tiedStones = [stone];
                    } else if (stone.journeyCount === maxJourneyCount) {
                        tiedStones.push(stone);
                    }
                }

                console.log(`Found ${tiedStones.length} stones with ${maxJourneyCount} journeys`);

                // If there's only one best stone, return it
                if (tiedStones.length === 1) {
                    bestStone = tiedStones[0];
                } 
                // If there are multiple stones with the same journey count, use tiebreaker
                else if (tiedStones.length > 1) {
                    bestStone = await findEarliestToReachCount(tiedStones, maxJourneyCount);
                }

                return bestStone;
            } catch (error) {
                console.error("Error finding best stone:", error);
                return null;
            }
        }

        // Function to find which stone reached the journey count first
        async function findEarliestToReachCount(stones, journeyCount) {
            try {
                let earliestStone = null;
                let earliestTimestamp = null;

                for (const stone of stones) {
                    // Get all journeys for this stone, ordered by timestamp
                    const journeysSnapshot = await db.collection('stones')
                        .doc(stone.id.toString())
                        .collection('journeys')
                        .orderBy('timestamp', 'asc')
                        .get();
                    
                    // Get the timestamp of when this stone reached the journey count
                    if (journeysSnapshot.size >= journeyCount) {
                        // The timestamp of the journey that made it reach the count
                        const journeyDoc = journeysSnapshot.docs[journeyCount - 1];
                        const timestamp = journeyDoc.data().timestamp;
                        
                        if (timestamp && (!earliestTimestamp || timestamp.toDate() < earliestTimestamp.toDate())) {
                            earliestTimestamp = timestamp;
                            earliestStone = stone;
                            console.log(`Stone ${stone.id} reached ${journeyCount} journeys at ${timestamp.toDate().toLocaleString()}`);
                        }
                    }
                }

                return earliestStone;
            } catch (error) {
                console.error("Error in tiebreaker:", error);
                return stones[0]; // Default to the first stone in case of error
            }
        }

        // Function to update the best stone display
        async function updateBestStoneDisplay(stone) {
            const bestStoneInfo = document.getElementById('bestStoneInfo');
            const bestStonePhoto = document.getElementById('bestStonePhoto');
            
            if (!stone) {
                bestStoneInfo.innerHTML = "No data";
                bestStonePhoto.innerHTML = "";
                return;
            }
            
            let photoUrl = null;
            
            // Try to get the stone's photo
            try {
                // Check Firestore for the photo URL
                const stoneDoc = await db.collection('stones').doc(stone.id.toString()).get();
                const stoneData = stoneDoc.data() || {};
                
                if (stoneData.featurePhoto && stoneData.featurePhoto.url) {
                    photoUrl = stoneData.featurePhoto.url;
                } else {
                    // If not in Firestore, try Storage directly
                    try {
                        const storageRef = storage.ref(`stones/${stone.id}/${stone.id}`);
                        photoUrl = await storageRef.getDownloadURL();
                    } catch (err) {
                        // No photo found
                        console.log(`No photo found for best stone #${stone.id}`);
                    }
                }
                
                // Create the content for stone info (left side)
                bestStoneInfo.innerHTML = `
                    <h3 style="margin: 5px 0 3px 0; font-size: 0.9em;">#${stone.id}</h3>
                    <button class="view-stone-btn" onclick="selectStone('${stone.id}')">
                        View
                    </button>
                `;
                
                // Create the content for stone photo (right side)
                if (photoUrl) {
                    bestStonePhoto.innerHTML = `
                        <img src="${photoUrl}" 
                             alt="Stone #${stone.id}" 
                             class="best-stone-photo"
                             onclick="openPhotoModal('${photoUrl}')"
                        >
                        <p style="margin: 3px 0 0 0; font-size: 0.75em; color: #666;">${stone.journeyCount} journeys</p>
                    `;
                } else {
                    bestStonePhoto.innerHTML = `
                        <div class="stone-placeholder" style="width: 70px; height: 70px;">
                            <p style="margin: 0; color: #666; font-size: 0.7em;">No photo</p>
                        </div>
                        <p style="margin: 3px 0 0 0; font-size: 0.75em; color: #666;">${stone.journeyCount} journeys</p>
                    `;
                }
                
            } catch (error) {
                console.error("Error updating best stone display:", error);
                bestStoneInfo.innerHTML = `Error`;
                bestStonePhoto.innerHTML = ``;
            }
        }

        // File input handling
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            document.getElementById('fileName').textContent = selectedFile ? selectedFile.name : '';
            document.getElementById('uploadBtn').disabled = !selectedFile;
        }

        // Modified upload stone photo function to refresh all stones map after upload
        async function uploadStonePhoto() {
            if (!selectedFile || !activeStoneId) return;
            
            showLoading();
            try {
                console.log(`Uploading photo for stone #${activeStoneId}`);
                
                // Create a reference to the file in Firebase Storage
                // Use simple naming with just the stoneID
                const storageRef = storage.ref(`stones/${activeStoneId}/${activeStoneId}`);
                
                // Upload the file
                const uploadTask = storageRef.put(selectedFile);
                
                // Listen for upload completion
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Progress handling if needed
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    }, 
                    (error) => {
                        // Error handling
                        console.error("Error uploading file:", error);
                        hideLoading();
                        alert("Error uploading file: " + error.message);
                    }, 
                    async () => {
                        try {
                            // Upload completed successfully
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log("File uploaded successfully. URL:", downloadURL);
                            
                            try {
                                // Store the reference in Firestore
                                await db.collection('stones').doc(activeStoneId).update({
                                    featurePhoto: {
                                        url: downloadURL,
                                        filename: selectedFile.name,
                                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }
                                });
                                console.log("Firestore updated with new photo URL");
                            } catch (firestoreError) {
                                console.error("Firestore update error:", firestoreError);
                                // Continue even if Firestore update fails - we still have the image URL
                            }
                            
                            // Reset the file input
                            document.getElementById('fileInput').value = '';
                            document.getElementById('fileName').textContent = '';
                            document.getElementById('uploadBtn').disabled = true;
                            selectedFile = null;
                            
                            // Display the photo directly instead of reloading
                            const journeyDetails = document.getElementById('journeyDetails');
                            
                            // Find the feature photo container in the new layout
                            let featurePhotoContainer = journeyDetails.querySelector('.feature-photo-container');
                            
                            // Update the feature photo content
                            if (featurePhotoContainer) {
                                featurePhotoContainer.innerHTML = `
                                    <h3 style="font-size: 0.9em; margin-top: 0;">Stone Photo</h3>
                                    <img src="${downloadURL}" 
                                        alt="Stone #${activeStoneId}" 
                                        class="stone-feature-image"
                                        onclick="openPhotoModal('${downloadURL}')"
                                    >
                                    <p style="margin-top: 5px; color: #666; font-size: 0.7em;">
                                        Just now
                                    </p>
                                `;
                            }
                            
                            // Refresh the all stones map to show the new photo
                            loadAllStonesLocations();
                            
                            hideLoading();
                            alert("Photo uploaded successfully!");
                            
                            // Scroll to the feature photo section
                            setTimeout(() => {
                                if (featurePhotoContainer) {
                                    featurePhotoContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100);
                            
                            // Update the stone card in the current view
                            updateStonePhotoIndicator(activeStoneId);
                            
                            // If this stone is the best performer, update its display
                            const bestStoneInfo = document.getElementById('bestStoneInfo');
                            if (bestStoneInfo && bestStoneInfo.innerHTML.includes(`#${activeStoneId}`)) {
                                // Re-find the best stone to update its display
                                const bestStone = await findBestPerformingStone();
                                if (bestStone) {
                                    await updateBestStoneDisplay(bestStone);
                                }
                            }
                            
                        } catch (error) {
                            console.error("Error processing upload completion:", error);
                            hideLoading();
                            alert("Photo uploaded successfully, but there was an issue displaying it. Please refresh the page.");
                        }
                    }
                );
            } catch (error) {
                console.error("Error in upload process:", error);
                hideLoading();
                alert("Error in upload process: " + error.message);
            }
        }

        // Update photo indicator on stone card after upload
        function updateStonePhotoIndicator(stoneId) {
            // Find the stone card
            const stoneCard = document.querySelector(`.stone-card[data-stone-id="${stoneId}"]`);
            if (stoneCard) {
                // Check if photo indicator already exists
                if (!stoneCard.querySelector('.photo-indicator')) {
                    // Add photo indicator
                    const photoIndicator = document.createElement('div');
                    photoIndicator.className = 'photo-indicator';
                    photoIndicator.style.color = '#84fab0';
                    photoIndicator.style.marginTop = '2px';
                    photoIndicator.innerHTML = '📷';
                    stoneCard.insertBefore(photoIndicator, stoneCard.querySelector('p'));
                }
            }
        }

        // Load recent updates across all stones
        async function loadRecentUpdates() {
            const recentUpdates = document.getElementById('recentUpdates');
            recentUpdates.innerHTML = '';
            showLoading();

            try {
                const stonesSnapshot = await db.collection('stones').get();
                let allUpdates = [];

                for (const stoneDoc of stonesSnapshot.docs) {
                    const journeysSnapshot = await stoneDoc.ref.collection('journeys')
                        .orderBy('timestamp', 'desc')
                        .limit(5)
                        .get();

                    journeysSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        allUpdates.push({
                            stoneId: stoneDoc.id,
                            ...data
                        });
                    });
                }

                allUpdates.sort((a, b) => b.timestamp - a.timestamp);

                allUpdates.slice(0, 20).forEach(update => {
                    const date = update.timestamp ? update.timestamp.toDate().toLocaleDateString() : 'Recent';
                    const time = update.timestamp ? update.timestamp.toDate().toLocaleTimeString() : '';
                    
                    const entry = document.createElement('div');
                    entry.className = 'update-entry';
                    
                    let photoHtml = '';
                    if (update.photoData && update.photoData.url) {
                        photoHtml = `
                            <img src="${update.photoData.url}" 
                                alt="Stone photo" 
                                class="update-photo"
                                onclick="openPhotoModal('${update.photoData.url}')"
                                loading="lazy"
                            >
                        `;
                    }

                    entry.innerHTML = `
                        <div class="update-content">
                            <h3>#${update.stoneId}</h3>
                            <p>${update.message}</p>
                            <p class="timestamp">${date} ${time}</p>
                            ${photoHtml}
                        </div>
                    `;
                    recentUpdates.appendChild(entry);
                });

            } catch (error) {
                console.error("Error loading recent updates:", error);
            } finally {
                hideLoading();
            }
        }

        // Create stone card
        async function createStoneCard(doc, journeyCount, hasPhoto) {
            // Create stone card
            const card = document.createElement('div');
            card.className = 'stone-card';
            card.dataset.stoneId = doc.id;
            
            // Add photo indicator if there's a photo
            card.innerHTML = `
                <h3>#${doc.id}</h3>
                ${hasPhoto ? '<div style="color: #84fab0; margin-top: 2px;">📷</div>' : ''}
                <p>${journeyCount} journeys</p>
            `;
            
            card.onclick = () => selectStone(doc.id);
            
            return card;
        }

        // Modified: Load stone card info
        async function loadStoneCardInfo(doc) {
            try {
                // Debug log
                console.log(`Loading stone card for ID: ${doc.id}`);
                
                const journeysSnapshot = await doc.ref.collection('journeys')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const journeyCount = journeysSnapshot.size;
                console.log(`Stone ${doc.id} has ${journeyCount} journeys`);
                
                // Get stone data to check for feature photo
                const stoneData = doc.data() || {};
                
                // Check if this stone has a feature photo
                let hasPhoto = stoneData.featurePhoto && stoneData.featurePhoto.url;
                let photoUrl = hasPhoto ? stoneData.featurePhoto.url : null;
                
                // If no photo in Firestore, check Storage directly
                if (!hasPhoto) {
                    try {
                        const storageRef = storage.ref(`stones/${doc.id}/${doc.id}`);
                        photoUrl = await storageRef.getDownloadURL();
                        hasPhoto = true;
                        console.log(`Found photo for stone ${doc.id} in Storage`);
                    } catch (err) {
                        // No photo in Storage either
                        hasPhoto = false;
                        console.log(`No photo found for stone ${doc.id}`);
                    }
                } else {
                    console.log(`Found photo for stone ${doc.id} in Firestore`);
                }
                
                // Create card
                const card = await createStoneCard(doc, journeyCount, hasPhoto);
                
                // Return all the information
                return { 
                    id: doc.id,
                    card: card, 
                    journeyCount: journeyCount,
                    hasPhoto: hasPhoto,
                    photoUrl: photoUrl
                };
            } catch (error) {
                console.error(`Error loading stone card ${doc.id}:`, error);
                return { id: doc.id, card: null, journeyCount: 0, hasPhoto: false, photoUrl: null };
            }
        }

        // Create folders based on stone grouping
        function createFolders(stones) {
            // Group stones into folders (1-8, 9-16, 17-24, etc.)
            const folderGroups = {};
            
            // Debug
            console.log(`Creating folders for ${stones.length} stones`);
            
            stones.forEach(stone => {
                // Extract the numeric part from the stone ID
                // This handles both numeric IDs and IDs with prefixes like "stone1"
                const stoneIdStr = stone.id.toString();
                const numericPart = stoneIdStr.replace(/\D/g, '');
                const stoneNum = parseInt(numericPart);
                
                if (isNaN(stoneNum)) {
                    console.warn(`Could not parse numeric ID from stone: ${stoneIdStr}`);
                    return; // Skip this stone
                }
                
                // Calculate folder bounds
                const folderIndex = Math.floor((stoneNum - 1) / 8);
                const minStoneInFolder = folderIndex * 8 + 1;
                const maxStoneInFolder = (folderIndex + 1) * 8;
                const folderId = `${minStoneInFolder}-${maxStoneInFolder}`;
                
                if (!folderGroups[folderId]) {
                    folderGroups[folderId] = [];
                }
                
                folderGroups[folderId].push(stone);
                console.log(`Added stone ${stoneIdStr} (numeric: ${stoneNum}) to folder ${folderId}`);
            });
            
            // Create folder cards
            const foldersGrid = document.getElementById('foldersGrid');
            foldersGrid.innerHTML = '';
            
            // Sort folder IDs numerically
            const sortedFolderIds = Object.keys(folderGroups).sort((a, b) => {
                const [minA] = a.split('-').map(Number);
                const [minB] = b.split('-').map(Number);
                return minA - minB;
            });
            
            console.log(`Created ${sortedFolderIds.length} folders: ${sortedFolderIds.join(', ')}`);
            
            sortedFolderIds.forEach(folderId => {
                const stones = folderGroups[folderId];
                const [minStone, maxStone] = folderId.split('-');
                const folderName = `Stones ${minStone}-${maxStone}`;
                
                // Count stones with photos
                const stonesWithPhotos = stones.filter(stone => stone.hasPhoto).length;
                
                const folderCard = document.createElement('div');
                folderCard.className = 'folder-card';
                folderCard.dataset.folderId = folderId;
                
                folderCard.innerHTML = `
                    <div class="folder-icon">📁</div>
                    <h3>${folderName}</h3>
                    <p>${stones.length} stones</p>
                `;
                
                folderCard.onclick = () => showStonesInFolder(folderId, folderName);
                foldersGrid.appendChild(folderCard);
            });
        }

        // Modified: Load all stones with proper ordering
        async function loadStones() {
            showLoading();
            try {
                const snapshot = await db.collection('stones').get();
                
                console.log(`Loaded ${snapshot.size} stones from Firestore`);
                
                // Debug: Log all stone IDs
                console.log("Stone IDs from Firestore:", snapshot.docs.map(doc => doc.id));
                
                let totalJourneys = 0;
                let activeThisMonth = 0;
                const currentMonth = new Date().getMonth();
                
                // Handle both numeric IDs and string IDs that might contain "stone" prefix
                const sortedDocs = [...snapshot.docs].sort((a, b) => {
                    // Extract numeric parts from IDs (removing any non-digit characters)
                    const numA = parseInt(a.id.toString().replace(/\D/g, ''));
                    const numB = parseInt(b.id.toString().replace(/\D/g, ''));
                    
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB; // Numeric sorting
                    } else {
                        return a.id.localeCompare(b.id); // String sorting as fallback
                    }
                });
                
                // Create an array of promises for loading each stone card
                const loadPromises = sortedDocs.map(doc => loadStoneCardInfo(doc));
                
                // Wait for all stone cards to be loaded
                const results = await Promise.all(loadPromises);
                
                // Filter out any null results
                allStones = results.filter(result => result.card !== null);
                
                console.log(`Successfully loaded ${allStones.length} stone cards`);
                
                // Calculate total journeys
                totalJourneys = allStones.reduce((total, stone) => total + stone.journeyCount, 0);
                
                // Check which stones are active this month
                for (let i = 0; i < sortedDocs.length; i++) {
                    const doc = sortedDocs[i];
                    const lastJourneySnapshot = await doc.ref.collection('journeys')
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                        
                    if (!lastJourneySnapshot.empty) {
                        const data = lastJourneySnapshot.docs[0].data();
                        if (data.timestamp && data.timestamp.toDate().getMonth() === currentMonth) {
                            activeThisMonth++;
                        }
                    }
                }

                // Update stats
                document.getElementById('totalStones').textContent = snapshot.size;
                document.getElementById('totalJourneys').textContent = totalJourneys;
                document.getElementById('activeStones').textContent = activeThisMonth;
                
                // Create folders based on stone grouping
                createFolders(allStones);
                
                // Find and display the best performing stone
                const bestStone = await findBestPerformingStone();
                if (bestStone) {
                    console.log(`Best performing stone: #${bestStone.id} with ${bestStone.journeyCount} journeys`);
                    await updateBestStoneDisplay(bestStone);
                } else {
                    console.log("Could not determine best performing stone");
                }

            } catch (error) {
                console.error("Error loading stones:", error);
            } finally {
                hideLoading();
            }
        }

        function initMap() {
            // Initialize journey map
            if (currentMap) {
                currentMap.remove();
            }

            currentMap = L.map('journeyMap').setView([0, 0], 2);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(currentMap);

            // Add a scale control to the map
            L.control.scale().addTo(currentMap);
            
            // Initialize all stones map if it doesn't exist
            if (!allStonesMap) {
                initializeAllStonesMap();
            }
        }
        
        function initializeAllStonesMap() {
            if (allStonesMap) {
                allStonesMap.remove();
            }
            
            allStonesMap = L.map('allStonesMap').setView([0, 0], 2);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(allStonesMap);
            
            // Add a scale control to the map
            L.control.scale().addTo(allStonesMap);
            
            // Load all stones' most recent locations
            loadAllStonesLocations();
        }
        
        async function loadAllStonesLocations() {
            showLoading();
            
            try {
                // Clear existing markers
                if (allStonesMarkers.length > 0) {
                    allStonesMarkers.forEach(marker => {
                        allStonesMap.removeLayer(marker);
                    });
                }
                allStonesMarkers = [];
                
                const stones = await db.collection('stones').get();
                
                const bounds = L.latLngBounds();
                const locationPromises = [];
                
                for (const stoneDoc of stones.docs) {
                    const stoneId = stoneDoc.id;
                    
                    // Get the most recent journey for this stone
                    const journey = await stoneDoc.ref.collection('journeys')
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                    
                    if (!journey.empty) {
                        const journeyData = journey.docs[0].data();
                        
                        // Get coordinates
                        let coords = journeyData.coordinates;
                        if (!coords && journeyData.location) {
                            coords = await getCoordinates(journeyData.location);
                        }
                        
                        if (coords) {
                            // Get stone feature photo if available
                            let photoUrl = null;
                            const stoneData = stoneDoc.data();
                            
                            if (stoneData.featurePhoto && stoneData.featurePhoto.url) {
                                photoUrl = stoneData.featurePhoto.url;
                            } else {
                                // Try to get from storage
                                try {
                                    const storageRef = storage.ref(`stones/${stoneId}/${stoneId}`);
                                    photoUrl = await storageRef.getDownloadURL();
                                } catch (err) {
                                    // No photo available
                                }
                            }
                            
                            // Prepare popup content - MADE MORE COMPACT (location removed)
                            let popupContent = `
                                <div style="text-align: center; max-width: 100px;">
                                    <h3 style="margin: 3px 0; font-size: 0.85em;">Stone #${stoneId}</h3>
                            `;
                            
                            // Add photo if available - MADE MORE COMPACT
                            if (photoUrl) {
                                popupContent += `
                                    <img src="${photoUrl}" 
                                        style="width: 90px; height: 90px; object-fit: contain; border-radius: 3px; margin-top: 4px; cursor: pointer; background: transparent; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));"
                                        onclick="openPhotoModal('${photoUrl}')"
                                    >
                                `;
                            } else if (journeyData.photoData && journeyData.photoData.url) {
                                // Use journey photo if stone photo not available
                                popupContent += `
                                    <img src="${journeyData.photoData.url}" 
                                        style="width: 90px; height: 90px; object-fit: contain; border-radius: 3px; margin-top: 4px; cursor: pointer; background: transparent; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));"
                                        onclick="openPhotoModal('${journeyData.photoData.url}')"
                                    >
                                `;
                            }
                            
                            popupContent += `
                                <p style="margin: 3px 0; font-size: 0.7em; cursor: pointer; color: #4a90e2;" 
                                   onclick="selectStone('${stoneId}')">
                                   View Journey History
                                </p>
                            </div>`;
                            
                            // Create marker with custom icon
                            const marker = L.marker([coords.lat, coords.lon], {
                                title: `Stone #${stoneId}`
                            }).addTo(allStonesMap).bindPopup(popupContent);
                            
                            allStonesMarkers.push(marker);
                            bounds.extend([coords.lat, coords.lon]);
                        }
                    }
                }
                
                // Fit the map to show all markers if there are any
                if (bounds.isValid()) {
                    allStonesMap.fitBounds(bounds, { padding: [30, 30] });
                }
                
            } catch (error) {
                console.error("Error loading all stones locations:", error);
            } finally {
                hideLoading();
            }
        }

        // Update existing stone selection function to refresh all stones map
        async function selectStone(stoneId) {
            showLoading();
            activeStoneId = stoneId;
            
            console.log(`Selecting stone #${stoneId}`);
            
            document.querySelectorAll('.stone-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.stoneId === stoneId) {
                    card.classList.add('active');
                }
            });

            initMap();

            try {
                // Fetch stone document to get feature photo
                const stoneDoc = await db.collection('stones').doc(stoneId).get();
                const stoneData = stoneDoc.data() || {};
                
                // Clear journey details and set title
                const journeyDetails = document.getElementById('journeyDetails');
                journeyDetails.innerHTML = `<h2>Stone #${stoneId} Journey History</h2>`;
                
                // Create a flex container for admin section and feature photo
                const flexContainer = document.createElement('div');
                flexContainer.style.display = 'flex';
                flexContainer.style.gap = '20px';
                flexContainer.style.marginBottom = '20px';
                flexContainer.style.justifyContent = 'center';
                journeyDetails.appendChild(flexContainer);
                
                // Add admin upload section
                const uploadSection = document.createElement('div');
                uploadSection.className = 'admin-upload-section';
                uploadSection.style.flex = '0 0 170px'; // Match the photo container width
                uploadSection.style.minHeight = '220px';
                uploadSection.style.padding = '10px';
                uploadSection.style.display = 'flex';
                uploadSection.style.flexDirection = 'column';
                uploadSection.innerHTML = `
                    <h3 style="font-size: 0.9em; margin-top: 0;">Upload Stone Photo</h3>
                    <div class="file-input-container" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                        <label for="fileInput" class="custom-file-upload">
                            Choose File
                        </label>
                        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
                        <div id="fileName" class="file-name"></div>
                        <button id="uploadBtn" class="upload-btn" onclick="uploadStonePhoto()" disabled>Upload</button>
                    </div>
                `;
                flexContainer.appendChild(uploadSection);
                
                // Try to get photo URL - first from Firestore, then from Storage
                let photoUrl = null;
                let uploadDate = 'Recently';
                
                // Check if the stone has a feature photo in Firestore
                if (stoneData.featurePhoto && stoneData.featurePhoto.url) {
                    photoUrl = stoneData.featurePhoto.url;
                    if (stoneData.featurePhoto.uploadedAt) {
                        const date = stoneData.featurePhoto.uploadedAt.toDate();
                        uploadDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    }
                } else {
                    // If not in Firestore, try to get directly from Storage
                    try {
                        console.log("Checking Storage for photo: ", `stones/${stoneId}/${stoneId}`);
                        const storageRef = storage.ref(`stones/${stoneId}/${stoneId}`);
                        photoUrl = await storageRef.getDownloadURL();
                        console.log("Found photo directly in Storage:", photoUrl);
                        
                        // Update Firestore with the photo URL for future reference
                        try {
                            await db.collection('stones').doc(stoneId).update({
                                featurePhoto: {
                                    url: photoUrl,
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }
                            });
                            console.log("Updated Firestore with Storage photo URL");
                        } catch (updateError) {
                            console.error("Error updating Firestore with photo URL:", updateError);
                        }
                    } catch (storageError) {
                        console.log("No feature photo found in Storage:", storageError);
                    }
                }
                
                // Create feature photo container (displayed or empty)
                const featurePhotoContainer = document.createElement('div');
                featurePhotoContainer.className = 'admin-upload-section feature-photo-container';
                featurePhotoContainer.style.flex = '0 0 170px'; // Fixed width for the thumbnail container
                featurePhotoContainer.style.minHeight = '220px';
                featurePhotoContainer.style.textAlign = 'center';
                featurePhotoContainer.style.display = 'flex';
                featurePhotoContainer.style.flexDirection = 'column';
                featurePhotoContainer.style.justifyContent = 'center';
                featurePhotoContainer.style.padding = '10px';
                
                // Display feature photo if it exists
                if (photoUrl) {
                    console.log("Displaying photo:", photoUrl);
                    featurePhotoContainer.innerHTML = `
                        <h3 style="font-size: 0.9em; margin-top: 0;">Stone Photo</h3>
                        <img src="${photoUrl}" 
                            alt="Stone #${stoneId}" 
                            class="stone-feature-image"
                            onclick="openPhotoModal('${photoUrl}')"
                        >
                        <p style="margin-top: 5px; color: #666; font-size: 0.7em;">
                            ${uploadDate}
                        </p>
                    `;
                } else {
                    featurePhotoContainer.innerHTML = `
                        <h3 style="font-size: 0.9em; margin-top: 0;">Feature Photo</h3>
                        <div class="stone-placeholder">
                            <p style="color: #666; margin: 0; font-size: 0.8em;">No photo yet</p>
                        </div>
                    `;
                    console.log("No photo found for this stone");
                }
                
                // Add the feature photo container to the flex container
                flexContainer.appendChild(featurePhotoContainer);

                const journeysSnapshot = await db.collection('stones')
                    .doc(stoneId)
                    .collection('journeys')
                    .orderBy('timestamp', 'desc')
                    .get();

                const coordinates = [];
                const bounds = L.latLngBounds();

                const orderedDocs = [...journeysSnapshot.docs].reverse();
                
                // Store data for each journey point to use when creating markers
                const journeyPoints = [];
                
                // First collect all coordinates and data
                for (const doc of orderedDocs) {
                    const data = doc.data();
                    
                    let coords = data.coordinates;
                    if (!coords && data.location) {
                        coords = await getCoordinates(data.location);
                    }

                    if (coords) {
                        coordinates.push([coords.lat, coords.lon]);
                        bounds.extend([coords.lat, coords.lon]);
                        
                        // Store the journey data along with coordinates
                        journeyPoints.push({
                            coordinates: [coords.lat, coords.lon],
                            data: data
                        });
                    }
                }

                if (coordinates.length > 0) {
                    // Create the main journey path polyline
                    const path = L.polyline(coordinates, {
                        color: '#3498db',
                        weight: 3,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round',
                        dashArray: '5, 10'
                    }).addTo(currentMap);

                    // Add numbered markers for each location
                    journeyPoints.forEach((point, index) => {
                        const isFinalPoint = index === journeyPoints.length - 1;
                        const data = point.data;
                        
                        // Create popup content
                        let popupContent = `
                            <div style="max-width: 200px;">
                                <b>${data.location}</b>
                                <p style="margin: 5px 0;">${data.message}</p>
                        `;
                        
                        if (data.photoData && data.photoData.url) {
                            popupContent += `
                                <img src="${data.photoData.url}" 
                                    style="width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer; background: transparent;"
                                    onclick="openPhotoModal('${data.photoData.url}')"
                                >
                            `;
                        }
                        
                        popupContent += '</div>';
                        
                        // Create a numbered marker
                        const markerIcon = L.divIcon({
                            html: `<div class="journey-marker${isFinalPoint ? ' journey-marker-final' : ''}">${index + 1}</div>`,
                            className: 'journey-marker-container',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        });
                        
                        // Add the marker with popup
                        L.marker(point.coordinates, {
                            icon: markerIcon
                        }).bindPopup(popupContent).addTo(currentMap);
                    });

                    currentMap.fitBounds(bounds, { padding: [50, 50] });
                    
                    // Highlight this stone on the all stones map
                    highlightStoneOnAllStonesMap(stoneId);
                }

                journeysSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : 'Recent';
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : '';
                    
                    let photoHtml = '';
                    if (data.photoData && data.photoData.url) {
                        photoHtml = `
                            <img src="${data.photoData.url}" 
                                alt="Stone location" 
                                class="journey-photo"
                                onclick="openPhotoModal('${data.photoData.url}')"
                                loading="lazy"
                            >
                        `;
                    }

                    const entry = document.createElement('div');
                    entry.className = 'journey-entry';
                    entry.innerHTML = `
                        <h3>📍 ${data.location}</h3>
                        ${photoHtml}
                        <p>${data.message}</p>
                        <p style="color: #666; font-size: 0.9em;">${date} ${time}</p>
                    `;
                    journeyDetails.appendChild(entry);
                });

            } catch (error) {
                console.error("Error loading stone journeys:", error);
            } finally {
                hideLoading();
            }
        }
        
        // Function to highlight the selected stone on the all stones map
        function highlightStoneOnAllStonesMap(stoneId) {
            // Find the marker for this stone and open its popup
            allStonesMarkers.forEach(marker => {
                const title = marker.options.title;
                if (title === `Stone #${stoneId}`) {
                    // Center the map on this marker and open popup
                    allStonesMap.setView(marker.getLatLng(), 12);
                    marker.openPopup();
                }
            });
        }

        // Initialize the dashboard
        window.onload = () => {
            loadStones();
            loadRecentUpdates();
            initMap();

            // Event listeners for modal
            document.getElementById('photoModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePhotoModal();
                }
            });

            // Handle escape key for modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePhotoModal();
                }
            });

            // Handle window resize for maps
            window.addEventListener('resize', function() {
                if (currentMap) {
                    currentMap.invalidateSize();
                }
                if (allStonesMap) {
                    allStonesMap.invalidateSize();
                }
            });
        };
    </script>
</body>
</html>
