<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Stone Journey</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .section {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .section.active {
            display: block;
            opacity: 1;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
            margin-top: 15px;
            font-size: 2em;
        }
        .language-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .language-buttons button {
            width: 190px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button {
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            color: #2c3e50;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .welcome-message {
            text-align: center;
            color: #34495e;
            margin: 20px auto;
            max-width: 400px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #84fab0;
        }
        .form-group {
            margin-bottom: 25px;
            padding: 0 15px; /* Add padding on both sides for symmetry */
            box-sizing: border-box;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 600;
            text-align: left; /* Ensure label alignment */
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        textarea {
            height: 120px;
            resize: vertical;
        }
        /* Make the submit button match as well */
        #submitButton {
            display: block;
            width: 90%;
            margin: 20px auto;
        }
        
        /* Photo upload container */
        .photo-upload {
            margin: 20px 0;
            text-align: center;
            width: 100%;
        }
        .journey-cards {
            margin-top: 40px;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e0e0e0;
        }
        .next-steps {
            background: #f1f8ff;
            padding: 20px;
            border-radius: 15px;
            margin: 30px 0;
            border-left: 5px solid #8fd3f4;
        }
        
        /* Updated stone thumbnail container - removed background & border */
        .stone-thumbnail-container {
            text-align: center;
            margin: 20px auto;
            max-width: 150px;
            background: transparent;
        }
        
        /* Updated stone thumbnail - drop-shadow instead of box-shadow */
        .stone-thumbnail {
            max-width: 100%;
            max-height: 150px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            cursor: pointer;
            transition: transform 0.2s;
            background: transparent;
        }
        .stone-thumbnail:hover {
            transform: scale(1.05);
        }
        
        #journeyMap {
            height: 400px;
            width: 100%;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .map-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #84fab0;
        }
        .location-share {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }
        .share-button {
            padding: 8px 16px;
            font-size: 14px;
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .share-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        #section4 {
            opacity: 1 !important;
        }
        .map-container {
            visibility: visible !important;
            opacity: 1 !important;
        }
        #journeyMap {
            opacity: 1 !important;
            z-index: 1;
            display: block !important;
        }
        .radio-group {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            transition: background-color 0.2s;
        }
        .radio-option:hover {
            background-color: #edf2f7;
        }
        .radio-option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }
        .radio-option label {
            display: inline;
            margin: 0;
            cursor: pointer;
        }
        .photo-upload {
            margin: 20px 0;
            text-align: center;
        }
        .photo-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 10px auto;
            display: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-button {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .upload-button input[type="file"] {
            display: none;
        }
        .photo-progress {
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            width: 0;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .journey-photo {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dashboard-button {
            display: block;
            width: 90%; /* Match other elements at 90% width */
            padding: 16px;
            margin: 20px auto; /* Auto margins for horizontal centering */
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            color: #2c3e50;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dashboard-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Updated stone photo container - removed background & border */
        .stone-photo-container {
            margin: 30px auto 0;
            text-align: center;
            max-width: 300px;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }
        
        /* Updated stone photo - drop-shadow instead of box-shadow */
        .stone-photo {
            max-width: 100%;
            max-height: 250px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            transition: transform 0.2s;
            background: transparent;
        }
        .stone-photo:hover {
            transform: scale(1.05);
            cursor: pointer;
        }
        
        /* Updated photo modal styles */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            background: transparent;
        }
        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25));
            background: transparent;
        }
        .close-modal {
            position: absolute;
            top: -40px;
            right: -40px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 10px;
            transition: transform 0.2s;
        }
        .close-modal:hover {
            transform: scale(1.1);
        }
        .loading-spinner {
            display: block;
            width: 50px;
            height: 50px;
            margin: 20px auto;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #84fab0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Added styles for journey stats */
        #journeyStats {
            text-align: center;
            font-weight: 600;
            color: #34495e;
            margin: 20px auto 40px; /* Increased bottom margin to add more space */
            padding: 15px;
            background: #f1f8ff;
            border-radius: 10px;
            max-width: 90%;
            border-left: 5px solid #8fd3f4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* New styles for journey markers - added from dashboard */
        .journey-marker-container {
            background: none;
            border: none;
        }
        
        .journey-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background-color: #0ead69;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .journey-marker-final {
            background-color: #e74c3c;
        }
        
        /* New placeholder style when no photo is available */
        .stone-placeholder {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(132, 250, 176, 0.2);
            border: 2px dashed rgba(132, 250, 176, 0.5);
        }
        
        /* Camera and Gallery buttons */
        .photo-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .photo-button {
            padding: 10px 15px;
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            color: #2c3e50;
        }

        /* iOS compatibility adjustments */
        input[type="file"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Error message styles */
        .error-message {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 3px solid #e74c3c;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Photo Modal -->
        <div id="photoModal" class="photo-modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closePhotoModal()">×</button>
                <img id="modalImage" src="" alt="Stone photo">
            </div>
        </div>

        <!-- Section 1: Language Selection -->
        <section id="section1" class="section active">
            <h1>🪨 Happy Stone Journey</h1>
            <div class="welcome-message">
                <h2>Welcome!</h2>
                <p>To share your location and message, choose your language/Om je locatie en bericht te delen, kies je taal</p>
            </div>
            <div class="language-buttons">
                <button onclick="selectLanguage('en')">English</button>
                <button onclick="selectLanguage('nl')">Nederlands</button>
            </div>
            <!-- Added stone photo container below language buttons -->
            <div id="stonePhotoContainer" class="stone-photo-container">
                <div class="loading-spinner"></div>
                <h3>Loading Stone Photo...</h3>
            </div>
        </section>

        <!-- Section 2: Project Explanation -->
        <section id="section2" class="section">
            <h1>🪨 <span class="lang-title">Happy Stone Journey</span></h1>
            <div class="welcome-message">
                <div id="explanation"></div>
            </div>
            <div style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
                <button onclick="showSection(3)" id="continueButton"></button>
            </div>
        </section>

        <!-- Section 3: Stone Info and Form -->
        <section id="section3" class="section">
            <h1>🪨 <span class="lang-title">Happy Stone Journey</span></h1>
            <div id="stoneThumbnailContainer" class="stone-thumbnail-container">
                <!-- Stone thumbnail will be loaded here -->
            </div>
            <div id="journeyStats"></div>
            <div id="stoneForm">
                <div class="form-group">
                    <label id="locationLabel"></label>
                    <input type="text" id="location" required>
                    <div class="location-share">
                        <span id="shareLocationText"></span>
                        <button onclick="shareLocation()" id="shareLocationButton" class="share-button"></button>
                    </div>
                </div>

                <div class="form-group">
                    <label id="messageLabel"></label>
                    <textarea id="message" required></textarea>
                </div>

                <div class="form-group">
                    <label id="photoLabel"></label>
                    <div class="photo-upload">
                        <div class="photo-buttons">
                            <button type="button" id="cameraButton" class="photo-button" onclick="openCamera()"></button>
                            <button type="button" id="galleryButton" class="photo-button" onclick="openGallery()"></button>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                        <div class="photo-progress">
                            <div class="progress-bar"></div>
                        </div>
                        <img id="photoPreview" class="photo-preview">
                        <div id="photoError" class="error-message"></div>
                    </div>
                </div>

                <button onclick="submitStoneJourney()" id="submitButton"></button>
                <div id="submitError" class="error-message"></div>
            </div>
        </section>

        <!-- Section 4: Next Steps and Journey History -->
        <section id="section4" class="section">
            <h1>🪨 <span class="lang-title">Happy Stone Journey</span></h1>
            <div class="map-container">
                <!-- Removed the map title h3 element to make it more compact -->
                <div id="journeyMap"></div>
            </div>
            <div class="next-steps" id="nextSteps"></div>
            <a id="dashboardButton" class="dashboard-button" target="_blank"></a>
            <div class="journey-cards" id="journeyCards"></div>
        </section>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBVMOTMubOV8Y1iEpK-E0TqZC5MptS6jpk",
            authDomain: "happy-stone-tracker.firebaseapp.com",
            projectId: "happy-stone-tracker",
            storageBucket: "happy-stone-tracker.firebasestorage.app",
            messagingSenderId: "454968587977",
            appId: "1:454968587977:web:cce4e67177cdf8029ebf18",
            measurementId: "G-CV38E0V9E4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        let currentMap = null;
        
        // Get stone ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const stoneId = urlParams.get('stone');

        // Store selected photo file (global variable)
        let selectedPhotoFile = null;
        let objectURL = null;
        
        // Detect iOS - used for iOS-specific handling
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        console.log("Device is iOS:", isIOS);

        let currentLanguage = 'en';
        const translations = {
            en: {
                title: 'Happy Stone Journey',
                explanation: `<h2>What is the Happy Stone Project?</h2>
                    <p>You've found a special stone that's on a mission to spread joy and connection throughout our community. Each person who receives it adds their own story to its journey.</p>
                    <p>After you share your message, give the stone to someone else, to continue spreading happiness!</p>`,
                continue: 'Continue',
                locationLabel: 'Where are you now? 📍',
                locationPlaceholder: 'City/Village',
                shareLocationText: 'Automatically share location',
                shareLocationButton: 'Share',
                messageLabel: 'Leave a message for the next person! ✨',
                photoLabel: 'Take a picture of the stone where you are now! 📸',
                cameraButton: 'Take Photo',
                galleryButton: 'Choose Photo',
                submit: 'Share Your Story',
                nextSteps: `<h3>What to Do Next?</h3>
                    <p>1. Give the stone to an acquaintance, someone you know</p>
                    <p>2. Preferably someone outside your direct environment</p>
                    <p>3. This way, the stone can travel far</p>
                    <p>4. Feel good knowing you're part of spreading joy in the world!</p>`,
                foundIn: 'Found in',
                sharedOn: 'Shared on',
                journeyCount: 'This stone has spread joy {count} times on its journey! ✨',
                locationNotFound: "Location not found on map",
                dashboardButton: "Want to keep following this stone's journey? Press this button and Bookmark me!",
                stonePhotoTitle: "Your Stone",
                noPhotoAvailable: "No photo available yet",
                photoUploadError: "There was a problem uploading your photo. Please try again.",
                formSubmitError: "There was a problem submitting your story. Please try again.",
                uploading: "Uploading..."
            },
            nl: {
                title: 'Happy Stone Reis',
                explanation: `<h2>Wat is het Happy Stone Project?</h2>
                    <p>Je hebt een speciale steen gevonden die op missie is om vreugde en verbinding te verspreiden in onze gemeenschap. Iedereen die de steen krijgt, voegt zijn eigen verhaal toe aan de reis.</p>
                    <p>Nadat je je bericht hebt gedeeld, geef de steen dan aan een ander, zodat het verspreiden van geluk zich kan voortzetten!</p>`,
                continue: 'Ga verder',
                locationLabel: 'Waar ben je nu? 📍',
                locationPlaceholder: 'Stad/Dorp',
                shareLocationText: 'Automatisch locatie delen',
                shareLocationButton: 'Delen',
                messageLabel: 'Laat een bericht achter voor de volgende persoon! ✨',
                photoLabel: 'Maak een foto van de steen op de plek waar je nu bent! 📸',
                cameraButton: 'Foto maken',
                galleryButton: 'Foto kiezen',
                submit: 'Deel je verhaal',
                nextSteps: `<h3>Wat nu te doen?</h3>
                    <p>1. Geef de steen aan iemand die je kent</p>
                    <p>2. Bij voorkeur iemand buiten je directe omgeving</p>
                    <p>3. Zo kan de steen een verre reis maken</p>
                    <p>4. Voel je goed wetende dat je bijdraagt aan het verspreiden van vreugde in de wereld!</p>`,
                foundIn: 'Gevonden in',
                sharedOn: 'Gedeeld op',
                journeyCount: 'Deze steen heeft {count} keer vreugde verspreid tijdens zijn reis! ✨',
                locationNotFound: "Locatie niet gevonden op de kaart",
                dashboardButton: "Wil je deze steen blijven volgen? Druk op deze knop en voeg bladwijzer toe!",
                stonePhotoTitle: "Jouw Steen",
                noPhotoAvailable: "Nog geen foto beschikbaar",
                photoUploadError: "Er was een probleem bij het uploaden van je foto. Probeer het opnieuw.",
                formSubmitError: "Er was een probleem bij het indienen van je verhaal. Probeer het opnieuw.",
                uploading: "Uploaden..."
            }
        };

        // Function to handle camera button click
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        // Function to handle gallery button click
        function openGallery() {
            document.getElementById('photoInput').click();
        }

        // Function to open photo modal
        function openPhotoModal(url) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex';
            modalImg.src = url;
        }

        // Function to close photo modal
        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.style.display = 'none';
        }

        // Helper function to show errors
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Load stone photo with better error handling and iOS compatibility
        async function loadStonePhoto() {
            if (!stoneId) {
                document.getElementById('stonePhotoContainer').innerHTML = `
                    <p>Please scan the QR code on your stone to see your stone's photo and journey.</p>
                `;
                return;
            }

            try {
                // First check if the stone has a feature photo in Firestore
                const stoneDoc = await db.collection('stones').doc(stoneId).get();
                const stoneData = stoneDoc.data() || {};
                
                let photoUrl = null;
                
                // Check if there's a feature photo URL in Firestore
                if (stoneData.featurePhoto && stoneData.featurePhoto.url) {
                    photoUrl = stoneData.featurePhoto.url;
                    console.log("Found photo in Firestore:", photoUrl);
                } else {
                    // If not in Firestore, try to get it directly from Storage
                    try {
                        console.log("Checking Storage for photo: ", `stones/${stoneId}/${stoneId}`);
                        const storageRef = storage.ref(`stones/${stoneId}/${stoneId}`);
                        photoUrl = await storageRef.getDownloadURL();
                        console.log("Found photo in Storage:", photoUrl);
                        
                        // Update Firestore with the photo URL for future reference
                        try {
                            await db.collection('stones').doc(stoneId).update({
                                featurePhoto: {
                                    url: photoUrl,
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }
                            });
                            console.log("Updated Firestore with Storage photo URL");
                        } catch (updateError) {
                            console.error("Error updating Firestore with photo URL:", updateError);
                        }
                    } catch (storageError) {
                        console.log("No feature photo found in Storage:", storageError);
                    }
                }
                
                const stonePhotoContainer = document.getElementById('stonePhotoContainer');
                const t = translations[currentLanguage];
                
                if (photoUrl) {
                    // For iOS, we'll preload the image to make sure it loads properly
                    if (isIOS) {
                        const img = new Image();
                        img.onload = function() {
                            stonePhotoContainer.innerHTML = `
                                <img src="${photoUrl}" alt="Stone #${stoneId}" class="stone-photo" 
                                     onclick="openPhotoModal('${photoUrl}')">
                            `;
                        };
                        img.onerror = function() {
                            console.error("Failed to load stone photo on iOS");
                            stonePhotoContainer.innerHTML = `
                                <div class="stone-placeholder">
                                    <p style="color: #666; margin: 0; font-size: 0.9em;">${t.noPhotoAvailable}</p>
                                </div>
                            `;
                        };
                        img.src = photoUrl;
                    } else {
                        stonePhotoContainer.innerHTML = `
                            <img src="${photoUrl}" alt="Stone #${stoneId}" class="stone-photo" 
                                 onclick="openPhotoModal('${photoUrl}')">
                        `;
                    }
                } else {
                    stonePhotoContainer.innerHTML = `
                        <div class="stone-placeholder">
                            <p style="color: #666; margin: 0; font-size: 0.9em;">${t.noPhotoAvailable}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Error loading stone photo:", error);
                document.getElementById('stonePhotoContainer').innerHTML = `
                    <div class="stone-placeholder">
                        <p style="color: #666; margin: 0; font-size: 0.9em;">Error loading stone photo</p>
                    </div>
                `;
            }
        }

        function selectLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-title').forEach(el => {
                el.textContent = translations[lang].title;
            });
            updateContent();
            
            // Update stone photo text with new language
            loadStonePhoto();
            
            showSection(2);
        }

        function showSection(num) {
            window.scrollTo(0, 0);
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(`section${num}`);
            targetSection.classList.add('active');
            
            if (num === 3) {
                loadStoneInfo();
            }
            
            if (num === 4) {
                setTimeout(() => {
                    if (currentMap) {
                        currentMap.invalidateSize();
                    }
                }, 100);
            }
        }

        function updateContent() {
            const t = translations[currentLanguage];
            document.getElementById('explanation').innerHTML = t.explanation;
            document.getElementById('continueButton').textContent = t.continue;
            document.getElementById('locationLabel').textContent = t.locationLabel;
            document.getElementById('location').placeholder = t.locationPlaceholder;
            document.getElementById('shareLocationText').textContent = t.shareLocationText;
            document.getElementById('shareLocationButton').textContent = t.shareLocationButton;
            document.getElementById('messageLabel').textContent = t.messageLabel;
            document.getElementById('photoLabel').textContent = t.photoLabel;
            document.getElementById('cameraButton').textContent = t.cameraButton;
            document.getElementById('galleryButton').textContent = t.galleryButton;
            document.getElementById('submitButton').textContent = t.submit;
            document.getElementById('nextSteps').innerHTML = t.nextSteps;
            
            // Update dashboard button
            const dashboardButton = document.getElementById('dashboardButton');
            dashboardButton.textContent = t.dashboardButton;
            dashboardButton.href = `https://tiemej.github.io/Stone-dashboard-specific-stone/?stone=${stoneId}`;
        }

        // Improved photo handling for iOS
        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log("Photo selected:", file.name, "size:", file.size, "type:", file.type);
            
            // Clear any previous object URL to prevent memory leaks
            if (objectURL) {
                URL.revokeObjectURL(objectURL);
            }
            
            // Hide any previous error messages
            document.getElementById('photoError').style.display = 'none';
            
            // For iOS, we need to check file type and handle HEIC/HEIF formats
            if (isIOS && (file.type === '' || file.type === 'image/heic' || file.type === 'image/heif')) {
                console.log("iOS HEIC/HEIF image detected");
                // We'll handle these during upload instead of preview, just store the file
                selectedPhotoFile = file;
                
                // Show a placeholder for the preview
                const preview = document.getElementById('photoPreview');
                preview.style.display = 'block';
                preview.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22300%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20300%20200%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_17e45eb143a%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A15pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_17e45eb143a%22%3E%3Crect%20width%3D%22300%22%20height%3D%22200%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22110.5%22%20y%3D%22107.1%22%3EPhoto%20Selected%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                return;
            }
            
            // Create a new object URL for the preview
            objectURL = URL.createObjectURL(file);
            
            // Show preview
            const preview = document.getElementById('photoPreview');
            preview.style.display = 'block';
            preview.src = objectURL;
            
            // Store the file in our global variable 
            selectedPhotoFile = file;
            
            console.log("Photo preview created successfully");
        }

        function shareLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`);
                            const data = await response.json();
                            const locationInput = document.getElementById('location');
                            locationInput.value = data.display_name;
                        } catch (error) {
                            console.error("Error getting location details:", error);
                            alert('Could not get location. Please enter it manually.');
                        }
                    },
                    function(error) {
                        console.error("Error getting location:", error);
                        alert('Could not get location. Please enter it manually.');
                    }
                );
            } else {
                alert('Location sharing is not supported by your browser. Please enter location manually.');
            }
        }

        // Completely rewritten stone info loader with better image handling
        async function loadStoneInfo() {
            try {
                // First check if the stone document exists
                const stoneDoc = await db.collection('stones').doc(stoneId).get();
                if (!stoneDoc.exists) {
                    // Create the stone document if it doesn't exist
                    await db.collection('stones').doc(stoneId).set({
                        created: firebase.firestore.FieldValue.serverTimestamp(),
                        description: 'A happy stone spreading joy!'
                    });
                }
                
                // Load the stone photo
                const stoneThumbnailContainer = document.getElementById('stoneThumbnailContainer');
                stoneThumbnailContainer.innerHTML = '<div class="loading-spinner"></div>';
                
                try {
                    // First look for feature photo in Firestore
                    const stoneData = stoneDoc.data() || {};
                    let photoUrl = null;
                    
                    if (stoneData.featurePhoto && stoneData.featurePhoto.url) {
                        photoUrl = stoneData.featurePhoto.url;
                    } else {
                        // If not in Firestore, try Storage directly
                        try {
                            const storageRef = storage.ref(`stones/${stoneId}/${stoneId}`);
                            photoUrl = await storageRef.getDownloadURL();
                            
                            // Update Firestore for future reference
                            try {
                                await db.collection('stones').doc(stoneId).update({
                                    featurePhoto: {
                                        url: photoUrl,
                                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }
                                });
                            } catch (updateError) {
                                console.error("Error updating Firestore with photo URL:", updateError);
                            }
                        } catch (storageError) {
                            console.log("No feature photo found in Storage:", storageError);
                        }
                    }
                    
                    // Special handling for iOS
                    if (isIOS && photoUrl) {
                        const img = new Image();
                        img.onload = function() {
                            stoneThumbnailContainer.innerHTML = `
                                <img src="${photoUrl}" alt="Stone #${stoneId}" class="stone-thumbnail" 
                                     onclick="openPhotoModal('${photoUrl}')">
                            `;
                        };
                        img.onerror = function() {
                            console.error("Failed to load stone thumbnail on iOS");
                            const t = translations[currentLanguage];
                            stoneThumbnailContainer.innerHTML = `
                                <div class="stone-placeholder">
                                    <p style="color: #666; margin: 0; font-size: 0.8em; text-align: center;">Stone #${stoneId}</p>
                                </div>
                            `;
                        };
                        img.src = photoUrl;
                    } else {
                        // Display the photo or a placeholder
                        if (photoUrl) {
                            stoneThumbnailContainer.innerHTML = `
                                <img src="${photoUrl}" alt="Stone #${stoneId}" class="stone-thumbnail" 
                                    onclick="openPhotoModal('${photoUrl}')">
                            `;
                        } else {
                            // Simple placeholder if no photo
                            stoneThumbnailContainer.innerHTML = `
                                <div class="stone-placeholder">
                                    <p style="color: #666; margin: 0; font-size: 0.8em; text-align: center;">Stone #${stoneId}</p>
                                </div>
                            `;
                        }
                    }
                } catch (photoError) {
                    console.error("Error loading stone photo:", photoError);
                    stoneThumbnailContainer.innerHTML = `
                        <div class="stone-placeholder">
                            <p style="color: #666; margin: 0; font-size: 0.8em; text-align: center;">Stone #${stoneId}</p>
                        </div>
                    `;
                }
                
                // Load journeys
                loadJourneys();
            } catch (error) {
                console.error("Error loading stone info: ", error);
            }
        }

        async function getCoordinates(locationString) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationString)}`);
                const data = await response.json();
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error("Error geocoding location:", error);
                return null;
            }
        }

        // Helper function to resize images for faster upload
        async function resizeImageForUpload(file) {
            return new Promise((resolve, reject) => {
                // Create an image element to load the file
                const img = new Image();
                img.onload = () => {
                    // Create a canvas to draw the resized image
                    const canvas = document.createElement('canvas');
                    
                    // Calculate new dimensions (max 1200px width/height)
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 1200;
                    
                    if (width > height && width > maxSize) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    } else if (height > maxSize) {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }
                    
                    // Set canvas dimensions
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw the resized image
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to blob with reduced quality for iOS
                    canvas.toBlob(
                        (blob) => {
                            if (!blob) {
                                reject(new Error("Failed to create blob"));
                                return;
                            }
                            resolve(blob);
                        },
                        'image/jpeg',
                        0.75 // Use lower quality for smaller file size
                    );
                };
                
                img.onerror = () => {
                    reject(new Error("Failed to load image for resizing"));
                };
                
                // Load the image from the file
                img.src = URL.createObjectURL(file);
            });
        }

        // Completely rewritten submission function for iOS compatibility
        async function submitStoneJourney() {
            // Show a loading indicator
            const submitButton = document.getElementById('submitButton');
            const originalButtonText = submitButton.textContent;
            const t = translations[currentLanguage];
            submitButton.textContent = t.uploading;
            submitButton.disabled = true;
            
            // Hide any previous error messages
            document.getElementById('submitError').style.display = 'none';
            document.getElementById('photoError').style.display = 'none';
            
            try {
                const location = document.getElementById('location').value;
                const message = document.getElementById('message').value;
                
                if (!location || !message) {
                    showError('submitError', 'Please fill in all required fields');
                    submitButton.textContent = originalButtonText;
                    submitButton.disabled = false;
                    return;
                }

                console.log("Creating journey with location:", location, "and message:", message);

                // Generate a unique ID for this journey entry
                const journeyId = db.collection('stones').doc(stoneId).collection('journeys').doc().id;
                console.log("Generated journey ID:", journeyId);

                // Create basic journey data
                const journeyData = {
                    journeyId: journeyId,
                    location: location,
                    message: message,
                    acquisition: "found", // Default value
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Add coordinates if we can get them
                try {
                    console.log("Getting coordinates for location:", location);
                    const coords = await getCoordinates(location);
                    if (coords) {
                        journeyData.coordinates = {
                            lat: coords.lat,
                            lon: coords.lon
                        };
                        console.log("Got coordinates:", coords);
                    } else {
                        console.log("No coordinates found for the location");
                    }
                } catch (coordError) {
                    console.error('Could not get coordinates:', coordError);
                }

                // Handle photo if present - completely rewritten for iOS compatibility
                if (selectedPhotoFile) {
                    console.log("Photo selected for upload:", selectedPhotoFile.type);
                    
                    try {
                        // Generate a unique filename
                        const fileExtension = selectedPhotoFile.name?.split('.').pop() || 'jpg';
                        const filename = `${journeyId}_${Date.now()}.${fileExtension}`;
                        
                        // Create a reference to the storage location
                        const photoRef = storage.ref(`stones/${stoneId}/photos/${filename}`);
                        
                        // For iOS, we'll always resize and convert to JPEG
                        const photoToUpload = await resizeImageForUpload(selectedPhotoFile);
                        console.log("Processed photo for upload, size:", photoToUpload.size);
                        
                        // Upload the processed photo
                        const uploadTask = photoRef.put(photoToUpload);
                        
                        // Monitor upload progress (especially important for iOS)
                        uploadTask.on(
                            'state_changed',
                            (snapshot) => {
                                // Show progress
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                console.log(`Upload progress: ${progress.toFixed(1)}%`);
                                
                                // Update progress bar if needed
                                const progressBar = document.querySelector('.progress-bar');
                                const progressContainer = document.querySelector('.photo-progress');
                                
                                if (progressBar && progressContainer) {
                                    progressContainer.style.display = 'block';
                                    progressBar.style.width = `${progress}%`;
                                }
                            },
                            (error) => {
                                // Handle unsuccessful uploads
                                console.error("Upload failed:", error);
                                throw new Error("Failed to upload photo: " + error.message);
                            },
                            async () => {
                                // Handle successful upload
                                const photoURL = await photoRef.getDownloadURL();
                                console.log("Upload complete. Photo URL:", photoURL);
                                
                                // Add photo data to journey data
                                journeyData.photoData = {
                                    filename: filename,
                                    url: photoURL,
                                    uploadTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                
                                // The upload completed successfully, now save to Firestore
                                await finalizeJourneySubmission(journeyData);
                            }
                        );
                        
                        // Return early as the upload completion handler will finalize the submission
                        return;
                        
                    } catch (photoError) {
                        console.error('Photo upload failed:', photoError);
                        showError('photoError', t.photoUploadError);
                        
                        // Continue without the photo
                        console.log("Continuing submission without photo");
                    }
                }
                
                // If we reach here, either there was no photo or the photo upload failed
                // Continue with submission without photo
                await finalizeJourneySubmission(journeyData);
                
            } catch (error) {
                console.error("Error submitting journey:", error);
                showError('submitError', t.formSubmitError);
                
                // Re-enable the submit button
                submitButton.textContent = originalButtonText;
                submitButton.disabled = false;
            }
        }
        
        // Helper function to complete the journey submission
        async function finalizeJourneySubmission(journeyData) {
            try {
                // Save the journey to Firestore
                console.log("Saving journey data to Firestore:", journeyData);
                await db.collection('stones').doc(stoneId).collection('journeys').doc(journeyData.journeyId).set(journeyData);
                console.log("Journey saved successfully");

                // Clean up
                if (objectURL) {
                    URL.revokeObjectURL(objectURL);
                    objectURL = null;
                }
                selectedPhotoFile = null;
                
                // Reset progress indicators
                const progressContainer = document.querySelector('.photo-progress');
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
                
                // Reset the photo preview
                const photoPreview = document.getElementById('photoPreview');
                if (photoPreview) {
                    photoPreview.style.display = 'none';
                    photoPreview.src = '';
                }
                
                // Show success by moving to next section
                showSection(4);
                loadJourneys();
                
            } catch (error) {
                console.error("Error finalizing journey submission:", error);
                const t = translations[currentLanguage];
                showError('submitError', t.formSubmitError);
                
                // Re-enable the submit button
                const submitButton = document.getElementById('submitButton');
                submitButton.textContent = t[currentLanguage].submit;
                submitButton.disabled = false;
            }
        }

        async function loadJourneys() {
            const journeyCards = document.getElementById('journeyCards');
            const t = translations[currentLanguage];
            journeyCards.innerHTML = '';
            
            try {
                const snapshot = await db.collection('stones').doc(stoneId)
                    .collection('journeys')
                    .orderBy('timestamp', 'desc')
                    .get();

                document.getElementById('journeyStats').innerHTML = t.journeyCount.replace('{count}', snapshot.size);
                
                if (currentMap) {
                    currentMap.remove();
                }

                currentMap = L.map('journeyMap', {
                    minZoom: 2,
                    maxZoom: 19,
                    scrollWheelZoom: true,
                    worldCopyJump: true
                }).setView([0, 0], 2);

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(currentMap);

                const journeyPoints = [];
                const coordinates = [];
                const bounds = L.latLngBounds();

                // Process journey data in chronological order (oldest first)
                const orderedDocs = [...snapshot.docs].reverse();
                
                for (const doc of orderedDocs) {
                    const data = doc.data();
                    
                    let coords = data.coordinates;
                    if (!coords && data.location) {
                        coords = await getCoordinates(data.location);
                    }
                    
                    if (coords) {
                        coordinates.push([coords.lat, coords.lon]);
                        bounds.extend([coords.lat, coords.lon]);
                        
                        // Store journey point data for creating markers
                        journeyPoints.push({
                            coordinates: [coords.lat, coords.lon],
                            data: data
                        });
                    }
                }

                if (coordinates.length > 0) {
                    // Create the journey polyline with dashed styling
                    const path = L.polyline(coordinates, {
                        color: '#3498db',
                        weight: 3,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round',
                        dashArray: '5, 10'
                    }).addTo(currentMap);

                    // Add numbered markers for each location
                    journeyPoints.forEach((point, index) => {
                        const isFinalPoint = index === journeyPoints.length - 1;
                        const data = point.data;
                        
                        // Create popup content
                        let popupContent = `
                            <div style="max-width: 200px;">
                                <b>${t.foundIn} ${data.location}</b>
                                <p style="margin: 5px 0;">${data.message}</p>
                        `;
                        
                        if (data.photoData && data.photoData.url) {
                            popupContent += `
                                <img src="${data.photoData.url}" 
                                    style="width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer;"
                                    onclick="openPhotoModal('${data.photoData.url}')"
                                >
                            `;
                        }
                        
                        popupContent += '</div>';
                        
                        // Create a numbered marker
                        const markerIcon = L.divIcon({
                            html: `<div class="journey-marker${isFinalPoint ? ' journey-marker-final' : ''}">${index + 1}</div>`,
                            className: 'journey-marker-container',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        });
                        
                        // Add the marker with popup
                        L.marker(point.coordinates, {
                            icon: markerIcon
                        }).bindPopup(popupContent).addTo(currentMap);
                    });

                    // Fit map to show all markers
                    currentMap.fitBounds(bounds, {
                        padding: [50, 50],
                        animate: true
                    });
                }

                // Create journey cards (in reverse chronological order - newest first)
                snapshot.docs.forEach((doc) => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : 'Recent';
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    let photoHtml = '';
                    if (data.photoData && data.photoData.url) {
                        photoHtml = `<img src="${data.photoData.url}" alt="Stone location" class="journey-photo" onclick="openPhotoModal('${data.photoData.url}')">`;
                    }
                    
                    card.innerHTML = `
                        <h3>📍 ${t.foundIn} ${data.location}</h3>  
                        ${photoHtml}
                        <p>${data.message}</p>
                        <p class="timestamp">${t.sharedOn} ${date}</p>
                    `;
                    journeyCards.appendChild(card);
                });

            } catch (error) {
                console.error("Error loading journeys:", error);
            }
        }

        // Event listeners for modals
        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePhotoModal();
            }
        });

        // Handle escape key for modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePhotoModal();
            }
        });

        // Initialize app and set up event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log("App initializing, detected iOS:", isIOS);
            
            // Load stone photo
            loadStonePhoto();
            
            // Set up photo input event listeners
            const photoInput = document.getElementById('photoInput');
            const cameraInput = document.getElementById('cameraInput');
            
            if (photoInput) {
                photoInput.addEventListener('change', handlePhotoSelect);
            }
            
            if (cameraInput) {
                cameraInput.addEventListener('change', handlePhotoSelect);
            }
            
            if (!stoneId) {
                alert('Please scan the QR code on your stone.');
            }
        });
    </script>
</body>
</html>
